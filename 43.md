NIP-43
======

Admission of clients to relays
-----------------------------------

`draft` `optional` `author:staab`

This NIP defines a way for clients to request admission to relays enforcing authentication as defined in NIP 42 by signing an ephemeral event.

## Motivation

A relay may want to allow clients to request access without degrading the UX by forcing users to leave the client. Relays may maintain a whitelist of pubkeys that are allowed to read or write, using invoices, invite codes, or other mechanisms.

## Claim Notice

Relays MAY indicate which claim types are accepted on connect or on restricted message using a NOTICE describing the claim type accepted and any additional data required to fulfill the claim.

```
["NOTICE", "claim: <type>", "<data>"]
```

## Claim Event

This NIP defines kind `22243` events which are intended to allow clients to request admission to a relay. It MUST have the following tags:

- `["r", "<url>"]` indicates the relay's url. This MUST match the relay the user is joining.
- `["claim", "<type>", "<data>"]` indicates the claim type and payload

The event's `created_at` MUST be now, plus or minus a few minutes. Clients MAY send a claim at any time, whether relays have indicated support using a NOTICE, but should be conservative about wasteful use of resources.

This event should be sent to a relay using the standard `EVENT` verb.

```json
{
  "id": "...",
  "pubkey": "...",
  "created_at": 1669695536,
  "kind": 22243,
  "tags": [
    ["relay", "wss://relay.example.com/"],
    ["claim", "invoice|invite|other", "<invoice id, invite code, or something else>"]
  ],
  "content": "",
  "sig": "..."
}
```

## Relay response

Upon receiving a claim, a relay MUST notify the client as to what the status of the claim is using an `OK` message. Successful claims may have any message, failed claims should use the same standard `"restricted: "` prefix specified by NIP 42. Some examples:

```
["OK", <event-id>, false, "restricted: That invoice is expired."]
["OK", <event-id>, false, "restricted: That is an unsupported claim."]
["OK", <event-id>, true, "restricted: You are already a member of this relay."]
["OK", <event-id>, true, "restricted: Welcome to wss://relay.bunk.skunk!"]
```

## Claim Types

### Invoice

A claim of type `invoice` may be sent via `NOTICE` to a client with a lightning invoice as the notice data. When the invoice has been paid, the client should send a `22243` event to the relay that issued the `NOTICE` with the invoice's id as the claim data: `["claim", "invoice", "<invoice id>"]`.

### Invite code

A claim of type `invite` may be sent via `NOTICE` to a client. No notice data is required in this flow. In order to use an invite code, a the client should send a `22243` event to the relay that issued the `NOTICE` with the invite code as the claim data: `["claim", "invite", "<invite code>"]`.
Invite codes MUST be generated by signing the relay's url with a private key. This allows a relay operator to issue his or her own invite codes, or allow a whitelist of other pubkeys to generate their own invite codes (for example, a list of moderators, or current members of the relay).
